<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet">
    <title>ZCity Loading</title>
</head>
<body>
    <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω (–±—É–¥–µ—Ç –∑–∞–º–µ–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ URL) -->
    <div class="custom-background" id="custom-background"></div>
    
    <!-- –ó–∞—Ç–µ–º–Ω—è—é—â–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ -->
    <div class="overlay-gradient"></div>
    
    <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Ç–∫–∞ (–ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞) -->
    <canvas id="grid"></canvas>
    
    <div class="centertext">
        <span class="text_1"></span>
        <span class="text_1" style="color:white;"></span>
        
        <div style="margin-top: -2vh;">
            <span class="info" id="server-name">Loading to SNB-RU...</span>
            <br>
            <span class="info" id="map-name"></span>
            <br>
            
            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div class="loading-container">
                <!-- –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <span class="info" id="loading-status">Connecting to server</span>
                
                <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–≥—Ä—É–∑–∫–µ -->
                <div class="loading-details" id="loading-details">
                    <!-- –≠—Ç–∞–ø –∑–∞–≥—Ä—É–∑–∫–∏ -->
                    <div class="loading-stage" id="loading-stage"></div>
                    
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —Ñ–∞–π–ª–µ -->
                    <div class="file-info" id="file-info">
                        <div class="file-name" id="file-name"></div>
                        <div class="file-progress" id="file-progress"></div>
                    </div>
                    
                    <!-- –°—á–µ—Ç—á–∏–∫ —Ñ–∞–π–ª–æ–≤ -->
                    <div class="files-counter" id="files-counter"></div>
                    
                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="loading-additional" id="loading-additional"></div>
                </div>
            </div>
            
            <br>
            <span id="text_tips" tip>Hey where tips?</span>
        </div>
    </div>
    
    <div class="info-down">
        discord.gg/ccVa3Mbk
    </div>

    <!-- –ê—É–¥–∏–æ –ø–ª–µ–µ—Ä (—Å–∫—Ä—ã—Ç—ã–π) -->
    <audio id="background-music" loop preload="auto"></audio>

    <script>
        const canvas = document.getElementById('grid');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth + 25;
        canvas.height = window.innerHeight + 25;
        
        const gridSize = 60;
        let offsetX = window.innerWidth / 2;
        let offsetY = -window.innerHeight / 2;
        const gridColor = 'rgba(223, 46, 46, 0.08)';
        
        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let x = offsetX % gridSize; x < canvas.width + gridSize; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 1.5;
                ctx.stroke();
            }

            for (let y = offsetY % gridSize; y < canvas.height + gridSize; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.height, y);
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 1.5;
                ctx.stroke();
            }

            offsetX -= 0.15;
            offsetY += 0.15;

            requestAnimationFrame(drawGrid);
        }

        drawGrid();

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth + 25;
            canvas.height = window.innerHeight + 25;
        });

        // Loading system
        var currentLang = navigator.language;
        let tipInterval;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        let currentStage = 'connecting';
        let currentFile = '';
        let downloadedBytes = 0;
        let totalBytes = 0;
        let filesDownloaded = 0;
        let totalFiles = 0;
        let luaStarted = false;
        let gameStarted = false;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –∏ –º—É–∑—ã–∫–∏
        let customBackgroundUrl = '';
        let musicUrl = '';
        let isMusicPlaying = false;
        
        // –°—Ç–∞–¥–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        const stages = {
            'connecting': {
                name: 'Connecting to server',
                next: 'downloading'
            },
            'downloading': {
                name: 'Downloading files',
                next: 'lua'
            },
            'lua': {
                name: 'Starting Lua scripts',
                next: 'spawning'
            },
            'spawning': {
                name: 'Spawning player',
                next: 'complete'
            },
            'complete': {
                name: 'Entering server',
                next: null
            }
        };
        
        function SelectTip() {
            const newLang = (currentLang === 'ru-RU' || currentLang === 'ru') ? 'ru' : 'en';

            fetch(`tips/${newLang}.json`)
                .then(response => response.json())
                .then(translationData => {
                    const tips = document.querySelectorAll('[tip]');
                    tips.forEach(element => {
                        var keys = Object.keys(translationData);
                        const key = keys[Math.floor(Math.random() * keys.length)];
                        if (translationData[key]) {
                            element.textContent = translationData[key];
                        }
                    });   
                })
                .catch(error => {
                    console.error('Error loading tips:', error);
                    document.getElementById('text_tips').textContent = 'Welcome to SNB-RU Servers!';
                });
        }

        const changingText = document.getElementById('text_tips');
        
        function changeText() {
            changingText.style.opacity = 0;
            changingText.addEventListener('transitionend', function handleTransition() {
                changingText.style.opacity = 1;
                SelectTip();
                changingText.removeEventListener('transitionend', handleTransition);
            }, { once: true });
        }

        function startTipRotation() {
            changeText();
            if (tipInterval) clearInterval(tipInterval);
            tipInterval = setInterval(changeText, 10000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–π—Ç–æ–≤
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ñ–æ–Ω–∞
        function SetBackgroundImage(url) {
            customBackgroundUrl = url;
            const bgElement = document.getElementById('custom-background');
            
            if (url && url.trim() !== '') {
                bgElement.style.backgroundImage = `url('${url}')`;
                bgElement.style.opacity = '1';
                console.log('Background set to:', url);
            } else {
                bgElement.style.backgroundImage = 'none';
                bgElement.style.opacity = '0';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–æ–Ω–æ–≤–æ–π –º—É–∑—ã–∫–∏
        function SetBackgroundMusic(url) {
            musicUrl = url;
            const audio = document.getElementById('background-music');
            
            if (url && url.trim() !== '') {
                audio.src = url;
                audio.load();
                
                // –ü—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –±—Ä–∞—É–∑–µ—Ä–æ–º)
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        isMusicPlaying = true;
                        console.log('Music started:', url);
                    }).catch(error => {
                        console.log('Auto-play was prevented. User interaction needed.');
                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø–æ –∫–ª–∏–∫—É
                        document.addEventListener('click', function playOnClick() {
                            audio.play();
                            isMusicPlaying = true;
                            document.removeEventListener('click', playOnClick);
                        }, { once: true });
                    });
                }
                
                console.log('Background music set to:', url);
            } else {
                audio.pause();
                audio.src = '';
                isMusicPlaying = false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç—å—é –º—É–∑—ã–∫–∏ (0.0 - 1.0)
        function SetMusicVolume(volume) {
            const audio = document.getElementById('background-music');
            audio.volume = Math.max(0, Math.min(1, volume));
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –º—É–∑—ã–∫–∏
        function StopMusic() {
            const audio = document.getElementById('background-music');
            audio.pause();
            isMusicPlaying = false;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –º—É–∑—ã–∫–∏
        function PlayMusic() {
            const audio = document.getElementById('background-music');
            audio.play();
            isMusicPlaying = true;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        function updateLoadingStatus() {
            const statusElement = document.getElementById('loading-status');
            const stageElement = document.getElementById('loading-stage');
            const fileNameElement = document.getElementById('file-name');
            const fileProgressElement = document.getElementById('file-progress');
            const filesCounterElement = document.getElementById('files-counter');
            const additionalElement = document.getElementById('loading-additional');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∞—Ç—É—Å
            if (luaStarted) {
                statusElement.textContent = '‚ö° Starting Lua scripts...';
            } else if (gameStarted) {
                statusElement.textContent = 'üéÆ Entering server...';
            } else if (currentStage === 'downloading' && totalFiles > 0) {
                statusElement.textContent = 'üì• Downloading files...';
            } else {
                statusElement.textContent = 'üîå Connecting...';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —ç—Ç–∞–ø –∑–∞–≥—Ä—É–∑–∫–∏
            if (stages[currentStage]) {
                stageElement.textContent = stages[currentStage].name;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
            if (currentFile && currentStage === 'downloading') {
                const fileName = currentFile.split('/').pop() || currentFile;
                fileNameElement.textContent = `üìÑ ${fileName}`;
                
                if (totalBytes > 0) {
                    const percent = (downloadedBytes / totalBytes * 100).toFixed(1);
                    fileProgressElement.textContent = `${formatBytes(downloadedBytes)} / ${formatBytes(totalBytes)} (${percent}%)`;
                } else {
                    fileProgressElement.textContent = formatBytes(downloadedBytes);
                }
                
                fileNameElement.style.opacity = '1';
                fileProgressElement.style.opacity = '1';
            } else {
                fileNameElement.style.opacity = '0';
                fileProgressElement.style.opacity = '0';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–∞–π–ª–æ–≤
            if (totalFiles > 0) {
                filesCounterElement.textContent = `üì¶ Files: ${filesDownloaded} / ${totalFiles}`;
                filesCounterElement.style.opacity = '1';
            } else {
                filesCounterElement.style.opacity = '0';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            if (luaStarted) {
                additionalElement.textContent = 'üîß Initializing Lua environment...';
                additionalElement.style.opacity = '1';
            } else if (currentStage === 'lua') {
                additionalElement.textContent = 'üîå Loading Lua modules...';
                additionalElement.style.opacity = '1';
            } else if (gameStarted) {
                additionalElement.textContent = '‚ú® Spawning player...';
                additionalElement.style.opacity = '1';
            } else {
                additionalElement.style.opacity = '0';
            }
        }

        // GMod integration
        function GameDetails(servername, serverurl, mapname, maxplayers, steamid, gamemode, volume, language) {
            // Parse server name
            const nameParts = servername.split("|");
            if (nameParts.length > 2) {
                document.getElementById('server-name').textContent = nameParts[2].trim();
            } else {
                document.getElementById('server-name').textContent = servername;
            }
            
            // Set map name
            document.getElementById('map-name').textContent = mapname ? 
                'üó∫Ô∏è ' + mapname.replace('gm_', '').replace('_', ' ') : '';
            
            // Set language
            if (language) {
                currentLang = language;
            }
            
            // Initial tip
            SelectTip();
            startTipRotation();
        }

        function onUpdatePlayerCount(players) {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–æ—Å—Ç–∞–≤–∏–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        function LoadingProgress(progress) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞–¥–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            if (progress < 0.1) {
                currentStage = 'connecting';
            } else if (progress < 0.6) {
                currentStage = 'downloading';
            } else if (progress < 0.85) {
                currentStage = 'lua';
            } else if (progress < 0.95) {
                currentStage = 'spawning';
            } else {
                currentStage = 'complete';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã
            if (progress >= 0.6 && !luaStarted) {
                luaStarted = true;
            }
            
            if (progress >= 0.95 && !gameStarted) {
                gameStarted = true;
            }
            
            updateLoadingStatus();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
        function DownloadingFile(fileName) {
            currentFile = fileName;
            currentStage = 'downloading';
            updateLoadingStatus();
        }

        function SetFilesTotal(numFiles) {
            totalFiles = numFiles;
            filesDownloaded = 0;
            updateLoadingStatus();
        }

        function SetFilesDownloaded(numFilesDownloaded) {
            filesDownloaded = numFilesDownloaded;
            updateLoadingStatus();
        }

        function SetTotalBytes(bytes) {
            totalBytes = bytes;
            updateLoadingStatus();
        }

        function SetDownloadedBytes(bytes) {
            downloadedBytes = bytes;
            updateLoadingStatus();
        }

        // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è Lua
        function LuaStarted() {
            luaStarted = true;
            currentStage = 'lua';
            updateLoadingStatus();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ä—Ç–µ Lua
            const additionalElement = document.getElementById('loading-additional');
            additionalElement.textContent = 'üéØ Lua Started!';
            additionalElement.style.opacity = '1';
            
            setTimeout(() => {
                if (additionalElement) {
                    additionalElement.style.opacity = '0';
                }
            }, 3000);
        }

        function LuaModuleLoaded(moduleName) {
            const additionalElement = document.getElementById('loading-additional');
            additionalElement.textContent = `üì¶ Loaded: ${moduleName}`;
            additionalElement.style.opacity = '1';
        }

        // Initialize
        setTimeout(() => {
            SelectTip();
            startTipRotation();
            updateLoadingStatus();
            
            // –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ GMOD):
            SetBackgroundImage('https://example.com/background.jpg');
            SetBackgroundMusic('https://rus.hitmotop.com/get/music/20200215/Tame_Impala_-_Borderline_68402463.mp3');
            SetMusicVolume(0.5);
        }, 500);
    </script>
</body>
</html>
