<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Condensed|Ubuntu+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <title>SNUFF EXPIE...</title>
</head>
<body>
    <canvas id="grid"></canvas>
    <div class="gradient"></div>
    <div class="background"></div>
    <div class="overhaul"></div>

    <nav>
        <div id="announcement"></div>
        <span id="map">You're playing on </span>
        <span id="steamid"></span>
    </nav>

    <div id="debug"></div>

    <main>
        <div class="title">
            <h2>Welcome to,</h2>
            <h1 id="title"></h1>
            <div id="history"></div>
        </div>
        <div class="under-nav"></div>
        <div class="loading-box"></div>
    </main>

    <div class="centertext">
        <span class="text_1"></span>
        <span class="text_1" style="color:white;"></span>
        
        <div style="margin-top: -2vh;">
            <span class="info" id="server-name">Loading to SNB-RU...</span>
            <br>
            <span class="info" id="map-name"></span>
            <br>
            <div class="loading-container">
                <span class="info" id="loading-status">Connecting to server</span>
                <div class="loading-bar">
                    <div class="loading-progress" id="loading-progress"></div>
                </div>
            </div>
            
            <!-- –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
            <div class="files-container">
                <div class="files-header">
                    <span class="files-title">Downloading files:</span>
                    <span class="files-count" id="files-count">0/0</span>
                </div>
                <div class="files-list" id="files-list">
                    <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã -->
                </div>
            </div>
            
            <br>
            <span id="text_tips" tip>Hey where tips?</span>
        </div>
    </div>
    
    <div class="info-down">
        discord.gg/ccVa3Mbk
    </div>

    <script src="js/lib/jquery-3.4.1.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <script>
        const canvas = document.getElementById('grid');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth + 25;
        canvas.height = window.innerHeight + 25;
        
        const gridSize = 60;
        let offsetX = window.innerWidth / 2;
        let offsetY = -window.innerHeight / 2;
        const gridColor = 'rgba(223, 46, 46, 0.08)';
        
        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let x = offsetX % gridSize; x < canvas.width + gridSize; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 1.5;
                ctx.stroke();
            }

            for (let y = offsetY % gridSize; y < canvas.height + gridSize; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.height, y);
                ctx.strokeStyle = gridColor;
                ctx.lineWidth = 1.5;
                ctx.stroke();
            }

            offsetX -= 0.15;
            offsetY += 0.15;

            requestAnimationFrame(drawGrid);
        }

        drawGrid();

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth + 25;
            canvas.height = window.innerHeight + 25;
        });

        // Loading tips system
        var currentLang = navigator.language;
        let tipInterval;
        let loadingProgress = 0;
        
        function SelectTip() {
            const newLang = (currentLang === 'ru-RU' || currentLang === 'ru') ? 'ru' : 'en';

            fetch(`tips/${newLang}.json`)
                .then(response => response.json())
                .then(translationData => {
                    const tips = document.querySelectorAll('[tip]');
                    tips.forEach(element => {
                        var keys = Object.keys(translationData);
                        const key = keys[Math.floor(Math.random() * keys.length)];
                        if (translationData[key]) {
                            element.textContent = translationData[key];
                        }
                    });   
                })
                .catch(error => {
                    console.error('Error loading tips:', error);
                    document.getElementById('text_tips').textContent = 'Welcome to SNB-RU Servers!';
                });
        }

        const changingText = document.getElementById('text_tips');
        
        function changeText() {
            changingText.style.opacity = 0;
            changingText.addEventListener('transitionend', function handleTransition() {
                changingText.style.opacity = 1;
                SelectTip();
                changingText.removeEventListener('transitionend', handleTransition);
            }, { once: true });
        }

        function startTipRotation() {
            changeText();
            if (tipInterval) clearInterval(tipInterval);
            tipInterval = setInterval(changeText, 10000);
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
        let totalFiles = 0;
        let downloadedFiles = 0;
        const maxHistoryItems = 8;

        function updateFilesCount() {
            const countElement = document.getElementById('files-count');
            if (countElement) {
                countElement.textContent = `${downloadedFiles}/${totalFiles}`;
            }
        }

        function addFileToList(filename, isStatus = false) {
            const filesList = document.getElementById('files-list');
            if (!filesList) return;

            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ñ–∞–π–ª–∞/—Å—Ç–∞—Ç—É—Å–∞
            const item = document.createElement('div');
            item.className = isStatus ? 'files-status-item' : 'files-item';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            const icon = isStatus ? 'üìã' : 'üìÅ';
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
            let displayName = filename;
            if (displayName.length > 40) {
                displayName = displayName.substring(0, 37) + '...';
            }
            
            item.innerHTML = `<span class="files-icon">${icon}</span> <span class="files-name">${displayName}</span>`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            filesList.prepend(item);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ
            const items = filesList.children;
            while (items.length > maxHistoryItems) {
                items[items.length - 1].remove();
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                item.style.opacity = '1';
                item.style.transform = 'translateX(0)';
            }, 10);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å—Ç–∞—Ä—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            Array.from(items).forEach((el, index) => {
                if (index > 0) {
                    el.style.opacity = Math.max(0.3, 1 - index * 0.15).toString();
                }
            });
        }

        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ main.js –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
        const originalSetFilesTotal = window.SetFilesTotal;
        window.SetFilesTotal = function(total) {
            totalFiles = total;
            downloadedFiles = 0;
            updateFilesCount();
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
            const filesList = document.getElementById('files-list');
            if (filesList) {
                filesList.innerHTML = '';
            }
            
            if (originalSetFilesTotal) {
                originalSetFilesTotal(total);
            }
        };

        const originalSetFilesNeeded = window.SetFilesNeeded;
        window.SetFilesNeeded = function(needed) {
            if (totalFiles > 0) {
                downloadedFiles = totalFiles - needed;
                updateFilesCount();
            }
            
            if (originalSetFilesNeeded) {
                originalSetFilesNeeded(needed);
            }
        };

        const originalDownloadingFile = window.DownloadingFile;
        window.DownloadingFile = function(filename) {
            // –û—á–∏—â–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
            const cleanFilename = filename.replace(/'/g, '').replace(/\?/g, '');
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –ø–æ–ª–Ω–æ–≥–æ –ø—É—Ç–∏
            const shortName = cleanFilename.split('/').pop() || cleanFilename;
            
            addFileToList(shortName, false);
            
            if (originalDownloadingFile) {
                originalDownloadingFile(filename);
            }
        };

        const originalSetStatusChanged = window.SetStatusChanged;
        window.SetStatusChanged = function(status) {
            addFileToList(status, true);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏
            const statusElement = document.getElementById('loading-status');
            if (statusElement) {
                if (status === 'Workshop Complete') {
                    statusElement.textContent = 'Workshop files loaded';
                } else if (status === 'Client info sent!') {
                    statusElement.textContent = 'Connecting to server...';
                } else if (status === 'Starting Lua...') {
                    statusElement.textContent = 'Starting game...';
                } else if (status.length < 30) {
                    statusElement.textContent = status;
                }
            }
            
            if (originalSetStatusChanged) {
                originalSetStatusChanged(status);
            }
        };

        // GMod integration
        function GameDetails(servername, serverurl, mapname, maxplayers, steamid, gamemode, volume, language) {
            // Parse server name
            const nameParts = servername.split("|");
            if (nameParts.length > 2) {
                document.getElementById('server-name').textContent = nameParts[2].trim();
            } else {
                document.getElementById('server-name').textContent = servername;
            }
            
            // Set map name
            document.getElementById('map-name').textContent = mapname ? 
                '' + mapname.replace('gm_', '').replace(/_/g, ' ') : '';
            
            // Set language
            if (language) {
                currentLang = language;
            }
            
            // Initial tip
            SelectTip();
            startTipRotation();

            // Call original GameDetails
            if (window.originalGameDetails) {
                window.originalGameDetails(servername, serverurl, mapname, maxplayers, steamid, gamemode);
            }
        }

        function onUpdatePlayerCount(players) {
            const maxPlayers = document.getElementById('server-name').textContent.includes('ZCity') ? 64 : 32;
            const playerCountElement = document.getElementById('player-count');
            if (playerCountElement) {
                playerCountElement.textContent = players + '/' + maxPlayers;
            }
        }

        function LoadingProgress(progress) {
            loadingProgress = Math.min(progress * 100, 100);
            const progressBar = document.getElementById('loading-progress');
            if (progressBar) {
                progressBar.style.width = loadingProgress + '%';
            }
            
            if (loadingProgress >= 100) {
                document.getElementById('loading-status').textContent = 'Starting game...';
            }
        }

        // Store original GameDetails
        window.originalGameDetails = window.GameDetails;
        // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é GameDetails
        window.GameDetails = GameDetails;

        // Initialize
        setTimeout(() => {
            SelectTip();
            startTipRotation();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–∞–π–ª–æ–≤
            updateFilesCount();
        }, 500);
    </script>
</body>
</html>
